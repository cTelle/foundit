(function(m){var q,f=m.Backbone,e=m._,n=f.$,r=m.console&&m.console.warn,s=m.console&&m.console.trace,t=f.View.prototype._configure,u=Array.prototype.push,p=Array.prototype.concat,v=Array.prototype.splice,g=f.View.extend({constructor:function(a){a=a||{};g.setupView(this,a);f.View.call(this,a)},insertView:function(a,b){return b?this.setView(a,b,!0):this.setView(a,!0)},insertViews:function(a){if(e.isArray(a))return this.setViews({"":a});e.each(a,function(b,c){a[c]=e.isArray(b)?b:[b]});return this.setViews(a)},
getView:function(a,b){null==a&&(a=b);return this.getViews(a).first().value()},getViews:function(a){var b;if("string"===typeof a)return b=this.views[a]||[],e.chain([].concat(b));b=e.chain(this.views).map(function(a){return e.isArray(a)?a:[a]},this).flatten();return"object"===typeof a?b.where(a):"function"===typeof a?b.filter(a):b},removeView:function(a){return this.getViews(a).each(function(a){a.remove()})},setView:function(a,b,c){var d,h,k,g=this;"string"!==typeof a&&(c=b,b=a,a="");this.views=this.views||
{};d=b.__manager__;h=this.views[a];if(!d)throw Error("Please set `View#manage` property with selector '"+a+"' to `true`.");k=b.getAllOptions();d.parent=g;d.selector=a;b.on("all",function(a){"beforeRender"!==a&&"afterRender"!==a&&g.trigger.apply(g,arguments)},b);if(!c)return d.hasRendered&&k.partial(g.$el,b.$el,g.__manager__,d),h&&e.each(p.call([],h),function(a){a.remove()}),this.views[a]=b;this.views[a]=p.call([],h||[],b);d.insert=!0;return b},setViews:function(a){e.each(a,function(a,c){if(e.isArray(a))return e.each(a,
function(a){this.insertView(c,a)},this);this.setView(c,a)},this);return this},render:function(){function a(){function a(){var b=d.afterRender;b&&b.call(c,c);c.trigger("afterRender",c);h.noel&&1<c.$el.length&&r&&!d.suppressWarnings&&(m.console.warn("Using `el: false` with multiple top level elements is not supported."),s&&m.console.trace())}var b;k&&(d.contains(k.el,c.el)||d.partial(k.$el,c.$el,f,h));c.delegateEvents();h.hasRendered=!0;(b=h.queue.shift())?b():delete h.queue;if(f&&f.queue)k.once("afterRender",
a);else a();return l.resolveWith(c,[c])}function b(){var b=c.getAllOptions();c._render(g._viewRender,b).done(function(){if(!e.keys(c.views).length)return a();var d=e.map(c.views,function(a){var b=e.isArray(a);return b&&a.length?e.reduce(a.slice(1),function(a,b){return a.then(function(){return b.render()})},a[0].render()):b?a:a.render()});b.when(d).done(a)})}var c=this,d=c.getAllOptions(),h=c.__manager__,k=h.parent,f=k&&k.__manager__,l=d.deferred();h.queue?u.call(h.queue,b):(h.queue=[],b(c,l));l.view=
c;return l},remove:function(){g._removeView(this,!0);return this._remove.apply(this,arguments)},getAllOptions:function(){return e.extend({},this,g.prototype.options,this.options)}},{_cache:{},_makeAsync:function(a,b){var c=a.deferred();c.async=function(){c._isAsync=!0;return b};return c},_viewRender:function(a,b){function c(c){c&&(m.noel?(c=n.trim(c),l=n(c),a.$el.slice(1).remove(),a.$el.replaceWith(l),a.setElement(l,!1)):b.html(a.$el,c));f.resolveWith(a,[a])}function d(a,d){var e,f=g._makeAsync(b,
function(a){c(a)});g.cache(h,d);d&&(e=b.render.call(f,d,a));f._isAsync||c(e)}var h,k,f,l,m=a.__manager__;return{render:function(){var c=a.serialize||b.serialize,l=a.template||b.template;e.isFunction(c)&&(c=c.call(a));f=g._makeAsync(b,function(a){d(c,a)});"string"===typeof l&&(h=b.prefix+l);if(k=g.cache(h))return d(c,k,h),f;"string"===typeof l?k=b.fetch.call(f,b.prefix+l):"function"===typeof l?k=l:null!=l&&(k=b.fetch.call(f,l));f._isAsync||d(c,k);return f}}},_removeViews:function(a,b){"boolean"===
typeof a&&(b=a,a=this);(a||this).getViews().each(function(a){(a.__manager__.hasRendered||b)&&g._removeView(a,b)})},_removeView:function(a,b){var c,d=a.__manager__;if(("boolean"===typeof a.keep?!a.keep:!a.options.keep)&&!0===d.insert||b)if(g.cleanViews(a),a._removeViews(!0),a.$el.remove(),d.parent){c=d.parent.views[d.selector];if(e.isArray(c))return e.each(e.clone(c),function(a,b){a&&a.__manager__===d&&v.call(c,b,1)});delete d.parent.views[d.selector]}},cache:function(a,b){if(a in this._cache&&null==
b)return this._cache[a];if(null!=a&&null!=b)return this._cache[a]=b},cleanViews:function(a){e.each(p.call([],a),function(a){var c;a.unbind();a.model instanceof f.Model&&a.model.off(null,null,a);a.collection instanceof f.Collection&&a.collection.off(null,null,a);a.stopListening();c=a.getAllOptions().cleanup;e.isFunction(c)&&c.call(a)})},configure:function(a){e.extend(g.prototype.options,a);a.manage&&(f.View.prototype.manage=!0);!1===a.el&&(f.View.prototype.el=!1);!0===a.suppressWarnings&&(f.View.prototype.suppressWarnings=
!0)},setupView:function(a,b){e.each(p.call([],a),function(a){if(!a.__manager__){var d,h=g.prototype,k=e.pick(a,q);e.defaults(a,{views:{},__manager__:{},_removeViews:g._removeViews,_removeView:g._removeView},g.prototype);b=a.options=e.defaults(b||{},a.options,h.options);d=e.pick(b,p.call(["events"],e.values(b.events)));e.extend(a,d);k.render!==g.prototype.render&&k.render!==f.View.prototype.render||delete k.render;e.extend(b,k);a._remove=f.View.prototype.remove;a._render=function(a,b){var c=b.beforeRender;
this.__manager__.hasRendered&&this._removeViews();c&&c.call(this,this);this.trigger("beforeRender",this);return a(this,b).render()};a.render=g.prototype.render;a.remove!==h.remove&&(a._remove=a.remove,a.remove=h.remove);d=b.views||a.views;e.keys(d).length&&(a.views={},a.setViews(d));a.options.template?a.options.template=b.template:a.template&&(b.template=a.template)}})}});f.Layout=g;g.VERSION="0.8.7";f.View.prototype._configure=function(a){var b,c;if("el"in a?!1===a.el:!1===this.el)b=!0;c=t.apply(this,
arguments);(a.manage||this.manage)&&g.setupView(this);this.__manager__&&(this.__manager__.noel=b,this.__manager__.suppressWarnings=a.suppressWarnings);return c};g.prototype.options={prefix:"",deferred:function(){return n.Deferred()},fetch:function(a){return e.template(n(a).html())},partial:function(a,b,c,d){d.selector&&(c.noel?(c=a.filter(d.selector),a=c.length?c:a.find(d.selector)):a=a.find(d.selector));d.insert?this.insert(a,b):this.html(a,b)},html:function(a,b){a.html(b)},insert:function(a,b){a.append(b)},
when:function(a){return n.when.apply(null,a)},render:function(a,b){return a(b)},contains:function(a,b){return n.contains(a,b)}};q=e.keys(g.prototype.options)})("object"===typeof global?global:this);
